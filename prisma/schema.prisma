generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id Int @id @default(autoincrement())

    username String @unique
    password String

    createdAt DateTime   @default(now())
    updatedAt DateTime   @updatedAt
    AuditLog  AuditLog[]
    Session   Session[]
}

model SchoolYear {
    id Int @id @default(autoincrement())

    name      String   @unique
    startDate DateTime
    endDate   DateTime

    createdAt    DateTime       @default(now())
    updatedAt    DateTime       @updatedAt
    SchoolPeriod SchoolPeriod[]
    StudentGrade StudentGrade[]
}

model SchoolPeriod {
    id Int @id @default(autoincrement())

    schoolYear SchoolYear @relation(fields: [schoolYearId], references: [id])
    month      Int

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    schoolYearId    Int
    MonthlyFee      MonthlyFee[]
    GradeFeeHistory GradeFeeHistory[]
    Payment         Payment[]
}

model Student {
    id Int @id @default(autoincrement())

    name String @unique

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    StudentGrade    StudentGrade[]
    Payment         Payment[]
    StudentDiscount StudentDiscount[]
}

model MonthlyFee {
    id Int @id @default(autoincrement())

    description   String
    amount        Decimal      @db.Decimal(15, 2)
    effectiveFrom SchoolPeriod @relation(fields: [schoolPeriodId], references: [id])

    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @updatedAt
    schoolPeriodId  Int
    GradeFeeHistory GradeFeeHistory[]
}

model GradeFeeHistory {
    id Int @id @default(autoincrement())

    monthlyFee   MonthlyFee   @relation(fields: [monthlyFeeId], references: [id])
    grade        Grade        @relation(fields: [gradeId], references: [id])
    schoolPeriod SchoolPeriod @relation(fields: [schoolPeriodId], references: [id])

    monthlyFeeId   Int
    gradeId        Int
    schoolPeriodId Int
    Payment        Payment[]

    @@unique([gradeId, schoolPeriodId])
}

model Grade {
    id Int @id @default(autoincrement())

    name String @unique

    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @updatedAt
    StudentGrade    StudentGrade[]
    GradeFeeHistory GradeFeeHistory[]
}

model StudentGrade {
    id Int @id @default(autoincrement())

    schoolYear SchoolYear @relation(fields: [schoolYearId], references: [id])
    grade      Grade      @relation(fields: [gradeId], references: [id])
    student    Student    @relation(fields: [studentId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    schoolYearId Int
    gradeId      Int
    studentId    Int
}

model Discount {
    id Int @id @default(autoincrement())

    name         String  @unique
    description  String
    amount       Decimal @db.Decimal(15, 2)
    isPercentage Boolean @default(true)

    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @updatedAt
    StudentDiscount StudentDiscount[]
}

model StudentDiscount {
    id       Int      @id @default(autoincrement())
    student  Student  @relation(fields: [studentId], references: [id])
    discount Discount @relation(fields: [discountId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    studentId      Int
    discountId     Int
    schoolPeriodId Int?
    Payment        Payment[]

    @@unique([studentId, discountId, schoolPeriodId])
}

model PaymentMethod {
    id Int @id @default(autoincrement())

    name                       String
    requiresManualVerification Boolean @default(true)
    requiresReferenceId        Boolean @default(true)

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    Payment   Payment[]
}

enum PaymentType {
    FULL
    PARTIAL
    FEE
    REFUND
    OVERDUE
}

model Payment {
    id           Int          @id @default(autoincrement())
    student      Student      @relation(fields: [studentId], references: [id])
    schoolPeriod SchoolPeriod @relation(fields: [schoolPeriodId], references: [id])
    amount       Decimal      @db.Decimal(15, 2)

    paymentMethod     PaymentMethod    @relation(fields: [paymentMethodId], references: [id])
    reference         String?
    discountApplied   StudentDiscount? @relation(fields: [studentDiscountId], references: [id])
    studentDiscountId Int?

    gradeFeeHistory GradeFeeHistory @relation(fields: [gradeFeeHistoryId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    studentId         Int
    schoolPeriodId    Int
    gradeFeeHistoryId Int
    paymentMethodId   Int
}

enum AuditableEntities {
    USER
    SCHOOL_YEAR
    SCHOOL_PERIOD
    STUDENT
    MONTHLY_FEE
    GRADE_FEE_HISTORY
    GRADE
    STUDENT_GRADE
    DISCOUNT
    STUDENT_DISCOUNT
    PAYMENT_METHOD
    PAYMENT
}

enum AuditLogActions {
    CREATE
    UPDATE
    SOFT_DELETE
    DELETE
}

model AuditLog {
    id        Int               @id @default(autoincrement())
    entity    AuditableEntities
    changes   String?
    action    AuditLogActions
    byUser    User              @relation(fields: [userId], references: [id])
    createdAt DateTime          @default(now())
    userId    Int
}

model Session {
    id Int @id @default(autoincrement())

    jti        String
    user       User     @relation(fields: [userId], references: [id])
    expiration DateTime

    createdAt DateTime @default(now())

    userId Int
}

model Setting {
    id Int @id @default(autoincrement())

    name  String @unique
    value String
}
